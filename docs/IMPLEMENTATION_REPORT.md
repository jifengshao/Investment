# Implementation Report

## Executive Summary

This document describes the production-quality implementation of a tax-aware, core-satellite investment system. The system provides:

1. **Initial Portfolio Creation** (`init`): Allocates new investments across accounts with asset-location optimization
2. **Ongoing Rebalancing** (`rebalance`): Corrects portfolio drift with strict or conservative modes
3. **Strategy Management** (`strategy`): Manages growth sleeve composition with policy enforcement
4. **Backtesting** (`backtest`): Simulates portfolio performance with comprehensive metrics

The implementation enforces key policy constraints:
- Household portfolios treated as single economic unit
- Two sleeves: Core (75% target, ETFs) and Growth (25% target, stocks + growth ETFs)
- Stabilizer minimum (15% in bonds)
- Growth sleeve cap (30% max)
- Single-stock max weight (10%)
- Taxable-sell-last rule for tax efficiency
- Leveraged ETF prohibition
- QQQ/SPYG exclusivity (choose one, not both)

## Repository Structure

```
Investment/
├── config/
│   ├── global_policy.yaml      # Policy constraints and thresholds
│   ├── accounts.yaml           # Household accounts and holdings
│   ├── asset_universe.yaml     # Asset metadata and targets
│   └── targets.generated.yaml  # Generated by strategy commands (auto-created)
├── common/
│   ├── __init__.py
│   └── config_loader.py        # YAML configuration loading
├── portfolio/
│   ├── __init__.py
│   ├── portfolio.py            # Portfolio domain model
│   ├── allocation.py           # Target allocation model
│   ├── holding.py              # Single holding model
│   └── sleeve.py               # Sleeve model (core/growth)
├── accounts/
│   ├── __init__.py
│   ├── account.py              # Base account model
│   ├── taxable.py              # Taxable account (future: lots, TLH)
│   └── tax_advantaged.py       # Tax-advantaged account (future: fund menu)
├── policy/
│   ├── __init__.py
│   ├── types.py                # AssetMeta dataclass
│   ├── allocation_policy.py    # Sleeve weight validation
│   ├── risk_policy.py          # Stabilizer minimum validation
│   ├── growth_policy.py        # Growth constraints validation
│   ├── rebalance_policy.py     # Drift threshold configuration
│   └── tax_policy.py           # Tax-aware trading rules
├── engine/
│   ├── __init__.py
│   ├── init_engine.py          # Initial portfolio allocation (NEW)
│   ├── drift_engine.py         # Drift detection
│   ├── rebalance_engine.py     # Rebalancing with modes (ENHANCED)
│   ├── trade_planner.py        # Tax-aware trade generation
│   ├── strategy_engine.py      # Growth sleeve operations (NEW)
│   └── explanation_engine.py   # Trade explanations
├── backtest/
│   ├── __init__.py
│   └── simulator.py            # Backtesting with enhanced metrics (ENHANCED)
├── reporting/
│   ├── __init__.py
│   ├── summary.py              # Portfolio summary
│   └── explainability.py       # Explainability reports
├── cli/
│   ├── __init__.py
│   └── main.py                 # CLI entrypoint (ENHANCED)
├── tests/
│   ├── test_invariants.py      # Policy invariant tests
│   ├── test_drift.py           # Drift detection tests (NEW)
│   ├── test_trade_planner.py   # Trade planner tests (NEW)
│   ├── test_init.py            # Init workflow tests (NEW)
│   ├── test_strategy.py        # Strategy engine tests (NEW)
│   └── test_smoke_imports.py   # Import and integration tests
├── docs/
│   └── IMPLEMENTATION_REPORT.md  # This document (NEW)
├── README.md                   # User documentation (ENHANCED)
├── CLAUDE.md                   # Claude Code guidance
└── requirements.txt            # Dependencies
```

## Key Design Decisions

### 1. Household-Level Portfolio Management

The portfolio is modeled as a collection of accounts (401k, taxable, etc.) that together form one economic unit. This enables:
- Cross-account drift detection against aggregate targets
- Asset-location optimization across account types
- Unified rebalancing decisions

### 2. Asset-Location Optimization

The system places assets in tax-optimal accounts:

| Asset Type | Preferred Account | Reason |
|------------|-------------------|--------|
| Bonds (BND, BNDX) | Tax-advantaged | Interest taxed as ordinary income |
| REITs (VNQ) | Tax-advantaged | Dividends taxed as ordinary income |
| Growth stocks | Taxable | Benefit from LTCG rates, step-up basis |
| Growth ETFs (QQQ) | Taxable | Tax-efficient, LTCG eligible |
| Broad market ETFs | Either (prefer taxable) | Tax-efficient, flexibility |

### 3. Taxable-Sell-Last Rule

When rebalancing requires selling, the system prioritizes:
1. Sell from tax-advantaged accounts first (no tax impact)
2. Sell from taxable accounts only as last resort

This minimizes realized capital gains and tax drag.

### 4. Conservative vs Strict Rebalance Modes

**Strict mode** (default):
- Generates all trades needed to reach targets
- May require selling in taxable accounts

**Conservative mode**:
- Only generates buy trades for drift correction
- Sells only when policy constraints are violated:
  - Single stock exceeds 10% weight
  - Growth sleeve exceeds 30% cap
  - Leveraged ETF held (must be sold)

This allows users to choose their tax sensitivity.

### 5. Strategy Engine with Policy Enforcement

The strategy engine (`engine/strategy_engine.py`) enforces rules on growth sleeve changes:

- **Growth cap (30%)**: Cannot add assets that would breach cap
- **Single-stock max (10%)**: Individual stocks limited
- **Leveraged ban**: TQQQ, SQQQ, etc. rejected
- **QQQ/SPYG exclusivity**: Choose one broad growth ETF, not both

Changes are persisted to `config/targets.generated.yaml`, leaving the base `asset_universe.yaml` unchanged.

### 6. Drift Detection with Dual Thresholds

Drift is detected using both absolute and relative thresholds:
- **Absolute**: `|current - target| > 5%`
- **Relative**: `|current - target| / target > 20%`

This handles both large allocations (where 5% absolute matters) and small allocations (where relative drift matters more).

## New Commands & Examples

### Initial Portfolio Creation

```bash
# Create initial allocation for $3M
$ python -m cli.main init --total 3000000 --explain

Initial Portfolio Allocation: $3,000,000
==================================================

Account Cash Distribution:
  401k: $1,125,000
  taxable: $1,875,000

Summary:
  total_value: 3000000
  num_trades: 13
  allocated_by_account:
    401k: $1,125,000
    taxable: $1,875,000

Trades:
  401k: BUY $450,000 BND  |  Initial allocation: stabilizer in tax-advantaged (tax-efficient)
  401k: BUY $112,500 BNDX  |  Initial allocation: stabilizer in tax-advantaged (tax-efficient)
  401k: BUY $112,500 VNQ  |  Initial allocation: low tax-efficiency asset in tax-advantaged
  ...
```

### Rebalance with Mode

```bash
# Conservative: buys only (unless constraints violated)
$ python -m cli.main rebalance --mode conservative --explain

Rebalance Recommendation (mode: conservative)
==================================================

Summary:
  total_value: $3,840,000
  stabilizer_weight: 19.53%
  mode: conservative

Trades:
  401k: BUY $36,000 BND  |  Rebalance buy (asset-location aware)
```

### Strategy Management

```bash
# View growth sleeve
$ python -m cli.main strategy show

Growth Sleeve Composition:
========================================
  QQQ       10.00%  (etf)
  AAPL       2.14%  (stock)
  MSFT       2.14%  (stock)
  ...
----------------------------------------
  Total     25.00%

  Growth cap: 30%
  Remaining:  5.00%

# Add new stock
$ python -m cli.main strategy add --ticker AMD --weight 0.02

Added AMD to growth sleeve at 2.00%
Updated targets saved to config/targets.generated.yaml

# Rotate weight
$ python -m cli.main strategy rotate --from TSLA --to NVDA --weight 0.01

Rotated 1.00% from TSLA to NVDA (TSLA: 2.14% -> 1.14%, NVDA: 2.14% -> 3.14%)
Updated targets saved to config/targets.generated.yaml
```

### Enhanced Backtest

```bash
$ python -m cli.main backtest

Backtest Results
============================================================

Scenario: with_bonds
----------------------------------------
  CAGR:                  7.89%
  Annualized Vol:       12.45%
  Max Drawdown:        -28.34%
  Worst Calendar Year: -18.23% (2008)
  Recovery Time:         487 days (16 months)
  Sharpe Ratio:          0.47
  Ending Value:       $1,234,567

Scenario: with_growth_tilt
----------------------------------------
  CAGR:                  9.12%
  Annualized Vol:       18.67%
  Max Drawdown:        -42.15%
  ...
```

## Major Modules Added/Changed

### New Modules

| Module | Responsibility |
|--------|---------------|
| `engine/init_engine.py` | Initial portfolio allocation with asset-location optimization |
| `engine/strategy_engine.py` | Growth sleeve add/remove/rotate with policy enforcement |
| `tests/test_drift.py` | Drift detection unit tests |
| `tests/test_trade_planner.py` | Trade planner tests (taxable-sell-last) |
| `tests/test_init.py` | Init workflow tests |
| `tests/test_strategy.py` | Strategy engine tests |

### Enhanced Modules

| Module | Changes |
|--------|---------|
| `cli/main.py` | Added `init` command, `strategy` subcommands, `--mode` for rebalance |
| `engine/rebalance_engine.py` | Added `RebalanceMode` enum, conservative mode logic |
| `backtest/simulator.py` | Added worst year, recovery time, Sharpe ratio; new scenarios |
| `config/global_policy.yaml` | Added `qqq_or_spyg_exclusive` setting |

## Tests Added

| Test File | What It Verifies |
|-----------|------------------|
| `test_invariants.py` | Stabilizer min, growth cap, single-stock max, leveraged ban |
| `test_drift.py` | Drift detection with absolute/relative thresholds |
| `test_trade_planner.py` | Taxable-sell-last rule, asset-location buying |
| `test_init.py` | Initial allocation sums correctly, respects asset location |
| `test_strategy.py` | Add/remove/rotate with policy enforcement |
| `test_smoke_imports.py` | All modules importable, CLI works, basic integration |

**Total: 62 tests passing**

## Known Limitations / Next Steps

### Current Limitations

1. **Dollar values, not shares**: Holdings are modeled as dollar amounts. Real brokers require share quantities and handle fractional shares differently.

2. **No lot-level tracking**: The system doesn't track individual tax lots, purchase dates, or cost basis. This limits:
   - Specific lot identification for selling
   - Tax-loss harvesting optimization
   - Wash sale detection

3. **No real-time prices**: The system is offline; it doesn't fetch live prices or execute trades.

4. **No contribution workflow**: New cash contributions are handled via `init` with the full portfolio; there's no incremental "add $X to existing portfolio" command.

5. **Single household assumption**: Designed for one household's accounts, not multi-household or advisor scenarios.

### Potential Next Steps

1. **Tax lot tracking**: Add `TaxLot` model with purchase date, cost basis, and lot selection strategies (FIFO, LIFO, specific ID).

2. **Tax-loss harvesting**: Detect losses available for harvest, suggest swaps to similar assets, track wash sale windows.

3. **Broker integration**: Abstract trade execution interface for paper trading or real broker APIs.

4. **Share-based modeling**: Convert dollar targets to share quantities with price lookup.

5. **Contribution workflow**: Add `contribute --amount X` command that optimally allocates new cash without selling.

6. **Rebalancing bands**: Add time-based or threshold-based automatic rebalancing triggers.

7. **Multi-household support**: Separate portfolios with shared policy templates.

8. **Performance attribution**: Break down returns by sleeve, asset, and time period.
